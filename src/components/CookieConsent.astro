---
const CONSENT_KEY = 'reignite_cookie_consent';
---

<div id="reignite-cookie-shell" class="fixed inset-x-0 bottom-0 z-50 pointer-events-none">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 pb-4 pointer-events-auto">
    <div
      id="reignite-cookie-banner"
      class="bg-white border border-ink/10 shadow-lg rounded-xl p-4 md:p-5 flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
      style="display: none"
    >
      <div class="space-y-2 md:space-y-1 md:max-w-3xl">
        <p class="text-sm font-semibold text-ink">
          We use cookies to make this site work properly.
        </p>
        <p class="text-xs text-ink/70">
          Weâ€™d also like to use analytics to see what pages people actually use. You can accept or reject. Read our
          <a href="/privacy" class="text-accent underline hover:text-black">privacy policy</a>.
        </p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button
          type="button"
          class="px-4 py-2 rounded-md bg-accent text-white text-xs font-semibold hover:bg-black transition"
          onclick="window.reigniteAcceptCookies()"
        >
          Accept
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-md bg-ink text-white/90 text-xs font-semibold hover:bg-black transition"
          onclick="window.reigniteRejectCookies()"
        >
          Reject
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-md bg-white text-ink text-xs font-semibold border border-ink/10 hover:border-ink/40 transition"
          onclick="window.reigniteToggleManage()"
        >
          Manage
        </button>
      </div>
    </div>

    <div
      id="reignite-cookie-manage"
      class="mt-3 bg-white border border-ink/10 shadow-md rounded-lg p-4 space-y-3"
      style="display: none"
    >
      <p class="text-sm font-semibold text-ink">Cookie preferences</p>
      <p class="text-xs text-ink/70">
        Necessary cookies are always on. Analytics cookies are optional.
      </p>
      <div class="flex items-center justify-between">
        <span class="text-sm text-ink">Analytics cookies</span>
        <label class="inline-flex items-center gap-2 text-sm text-ink">
          <input type="checkbox" id="reignite-analytics-toggle" class="h-4 w-4" />
          Allow
        </label>
      </div>
      <div class="flex gap-2">
        <button
          type="button"
          class="px-4 py-2 rounded-md bg-accent text-white text-xs font-semibold hover:bg-black transition"
          onclick="window.reigniteSaveManage()"
        >
          Save
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-md bg-white text-ink text-xs font-semibold border border-ink/10 hover:border-ink/40 transition"
          onclick="window.reigniteToggleManage()"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    const CONSENT_KEY = 'reignite_cookie_consent';

    function getConsent() {
      try {
        const raw = localStorage.getItem(CONSENT_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        // Log the error but return null to fail gracefully
        console.error('Error reading consent from localStorage:', e); 
        return null;
      }
    }

    function saveConsent(consent) {
      localStorage.setItem(CONSENT_KEY, JSON.stringify(consent));
      // CRITICAL: Fire the custom event that BaseLayout listens for
      window.dispatchEvent(new CustomEvent('reignite:consent-updated', { detail: consent }));
    }

    function showBanner() {
      const banner = document.getElementById('reignite-cookie-banner');
      if (banner) banner.style.display = 'flex';
    }

    function hideBanner() {
      const banner = document.getElementById('reignite-cookie-banner');
      if (banner) banner.style.display = 'none';
    }

    // exposed functions
    window.reigniteAcceptCookies = function () {
      saveConsent({ necessary: true, analytics: true });
      hideBanner();
    };

    window.reigniteRejectCookies = function () {
      saveConsent({ necessary: true, analytics: false });
      hideBanner();
    };
    
    window.reigniteToggleManage = function () {
      const panel = document.getElementById('reignite-cookie-manage');
      if (!panel) return;
      // sync current state
      const existing = getConsent();
      const toggle = document.getElementById('reignite-analytics-toggle');
      if (toggle) {
        toggle.checked = existing ? !!existing.analytics : false;
      }

      panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
    };
    
    window.reigniteSaveManage = function () {
      const toggle = document.getElementById('reignite-analytics-toggle');
      const consent = {
        necessary: true,
        analytics: toggle ? !!toggle.checked : false,
      };
      saveConsent(consent);
      hideBanner();
      const panel = document.getElementById('reignite-cookie-manage');
      if (panel) panel.style.display = 'none';
    };

    document.addEventListener('DOMContentLoaded', () => {
      const existing = getConsent();
      if (!existing) {
        // First visit: Default consent (denied) is already set in BaseLayout. Show banner.
        showBanner();
      } else {
        // Returning visitor: Dispatch the event to immediately update GA4 consent state in BaseLayout.
        // This ensures tracking is re-enabled/re-denied with the stored preference.
        window.dispatchEvent(new CustomEvent('reignite:consent-updated', { detail: existing }));
      }
    });
  })();
</script>
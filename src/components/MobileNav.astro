---
/**
 * Accessible headless mobile navigation
 * - Button controls dialog via aria-controls/expanded
 * - Menu is hidden by default;
 shown when data-state="open"
 * - Closes on: Esc, outside click, link click, and when resizing to >= md
 */
import CtaLink from './CtaLink.astro'; // <-- New import
---

<div class="md:hidden">
  <button
    id="menuButton"
    class="flex items-center gap-2 rounded-md p-2 hover:bg-ink/5 focus:outline-none focus:ring-2 focus:ring-accent/30"
    aria-expanded="false"
    aria-controls="mobileMenu"
    aria-haspopup="true"
  >
    <span class="sr-only">Open main menu</span>
    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
   
  </svg>
  </button>

  <div
    id="mobileMenu"
    role="dialog"
    aria-label="Main navigation"
    data-state="closed"
    hidden
    class="pointer-events-none fixed inset-x-0 top-20 z-50 border-b border-ink/10 bg-surface opacity-0 transition-opacity duration-200 ease-out data-[state=open]:pointer-events-auto data-[state=open]:opacity-100"
  >
    <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 grid gap-2" aria-label="Mobile">
      <CtaLink href="/services" category="MOBILENAV" label="SERVICES" class="rounded px-3 py-2 text-base font-medium hover:bg-ink/5 focus:bg-ink/5">Services</CtaLink>
      <CtaLink href="/work" category="MOBILENAV" label="WORK" class="rounded px-3 py-2 text-base font-medium hover:bg-ink/5 focus:bg-ink/5">Work</CtaLink>
      <CtaLink href="/about" category="MOBILENAV" label="ABOUT" class="rounded 
 px-3 py-2 text-base font-medium hover:bg-ink/5 focus:bg-ink/5">About</CtaLink>
      <CtaLink href="/blog" category="MOBILENAV" label="INSIGHTS" class="rounded px-3 py-2 text-base font-medium hover:bg-ink/5 focus:bg-ink/5">Insights</CtaLink>
      <CtaLink href="#contact" category="MOBILENAV_CTA" label="CONTACT_US" class="mt-1 btn-primary text-base px-4 py-2">Contact us</CtaLink>
    </nav>
  </div>

  <script>
    // Helpers
    const btn = document.getElementById('menuButton');
 const panel = document.getElementById('mobileMenu');

    const openMenu = () => {
      if (!btn || !panel) return;
 btn.setAttribute('aria-expanded', 'true');
      panel.dataset.state = 'open';
      panel.hidden = false;
      // Optional: prevent background scroll on small screens
      document.documentElement.style.overflow = 'hidden';
 };

    const closeMenu = () => {
      if (!btn || !panel) return;
      btn.setAttribute('aria-expanded', 'false');
 panel.dataset.state = 'closed';
      // Delay setting hidden until opacity transition ends for smoother close
      panel.addEventListener('transitionend', function handler() {
        if (panel.dataset.state === 'closed') panel.hidden = true;
        panel.removeEventListener('transitionend', handler);
      });
 // If no transition support, ensure it's hidden quickly
      setTimeout(() => { if (panel.dataset.state === 'closed') panel.hidden = true; }, 220);
 document.documentElement.style.overflow = '';
    };

    const toggleMenu = () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
 expanded ? closeMenu() : openMenu();
    };

    // Events
    btn?.addEventListener('click', toggleMenu);
 // Close on Esc
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && panel?.dataset.state === 'open') {
        closeMenu();
        btn?.focus();
      }
    });
 // Close on outside click
    document.addEventListener('click', (e) => {
      if (!panel || panel.dataset.state !== 'open') return;
      const clickInsidePanel = panel.contains(e.target);
      const clickOnButton = btn.contains(e.target);
      if (!clickInsidePanel && !clickOnButton) closeMenu();
    });
 // Close when a link is clicked
    panel?.querySelectorAll('a').forEach((a) => {
      a.addEventListener('click', () => closeMenu());
    });
 // Close when resizing to md and above (keeps state sane)
    const mq = window.matchMedia('(min-width: 768px)');
 const onResize = () => { if (mq.matches && panel?.dataset.state === 'open') closeMenu(); };
    mq.addEventListener ? mq.addEventListener('change', onResize) : mq.addListener(onResize);
 </script>
</div>
---
// src/pages/local-offer-apply.astro

import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieConsent from '../components/CookieConsent.astro';
import Button from '../components/Button.astro';
import CtaLink from '../components/CtaLink.astro';

import { MessageCircle, MapPin, BadgePercent } from '@lucide/astro';

import {
  offerLive,
  slotsRemaining,
  totalSlots,
  discountPercent,
  eligiblePlaces
} from '../data/local-offer.config';

const pageTitle = 'Apply for the Local Offer | Reignite Solutions';
const pageDesc =
  'Apply for the Ilkley local hello offer. One-time discount for businesses within 5 miles of Ilkley town centre.';

const url = new URL(Astro.request.url);
const sent = url.searchParams.get('sent');
const error = url.searchParams.get('error');

const errorMessages = {
  name_missing: 'Please tell us your name.',
  email_missing: 'Please add your email address.',
  email_invalid: 'That email doesn’t look right.',
  message_missing: 'Tell us a bit about what you need.',
  location_missing: 'Tell us where your business is based.',
  postcode_invalid: 'That postcode doesn’t look like a valid UK postcode.',
  server_fail: 'Something went wrong. Try again or email us directly.',
};
---

<BaseLayout title={pageTitle} description={pageDesc} canonical="/local-offer-apply">
  <Header />

  <main class="min-h-screen bg-surface text-ink">
    {/* Hero */}
    <section class="pt-28 md:pt-32 pb-10 bg-white border-b border-ink/5">
      <div class="container-reignite max-w-4xl space-y-6">
        <span
          class={`inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.25em] px-4 py-1 rounded-full ${
            offerLive ? 'bg-accent/10 text-accent' : 'bg-ink/10 text-ink'
          }`}
        >
          <BadgePercent class="w-3.5 h-3.5" aria-hidden="true" />
          Local hello offer
        </span>

        <h1 class="text-3xl md:text-4xl font-display font-extrabold">
          Apply for the local offer
        </h1>

        <p class="text-lg text-ink/70 leading-relaxed">
          {offerLive && slotsRemaining > 0 ? (
            <>
              You’ll get <strong>{discountPercent}% off</strong> one project if you’re within 5 miles of Ilkley town centre.
              <br />
              <span class="text-xs">Slots remaining: {slotsRemaining} of {totalSlots}.</span>
              <span class="text-xs ml-2">Terms and conditions apply.</span>
            </>
          ) : (
            <>
              This offer is currently closed. If you still want help, use the normal contact form.
            </>
          )}
        </p>

        <div class="text-sm text-ink/70 bg-surface border border-ink/10 rounded-xl p-4">
          Eligible places include: <strong>{eligiblePlaces.join(', ')}</strong>.
        </div>
      </div>
    </section>

    {/* Form */}
    <section class="py-8 md:py-12">
      <div class="container-reignite max-w-4xl">
        <div class="bg-white border border-ink/10 rounded-2xl shadow-sm p-6 md:p-8">
          <div class="mb-6 space-y-1">
            <h2 class="text-xl font-display font-bold">Quick application</h2>
            <p class="text-sm text-ink/60">
              Fill this in and we’ll come back to you with next steps.
            </p>
          </div>

          <form
            method="POST"
            action="/api/worker"
            class="space-y-5"
          >
            <input type="hidden" name="formType" value="local-offer" />

            {/* Honeypot (hidden) */}
            <div class="hidden" aria-hidden="true">
              <label>
                Leave this field empty
                <input type="text" name="website_hp" tabindex="-1" autocomplete="off" />
              </label>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <label class="space-y-1">
                <span class="text-sm font-semibold">Your name *</span>
                <input
                  name="name"
                  required
                  minlength="2"
                  class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
                />
              </label>

              <label class="space-y-1">
                <span class="text-sm font-semibold">Email *</span>
                <input
                  name="email"
                  type="email"
                  required
                  class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
                />
              </label>
            </div>

            <label class="space-y-1 block">
              <span class="text-sm font-semibold">Business name *</span>
              <input
                name="company"
                required
                class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
              />
            </label>

            <div class="grid gap-4 md:grid-cols-2">
              <label class="space-y-1">
                <span class="text-sm font-semibold">Town / village *</span>
                <input
                  name="town"
                  required
                  class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
                />
              </label>

              <label class="space-y-1">
                <span class="text-sm font-semibold">Postcode</span>
                <input
                  name="postcode"
                  class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
                  placeholder="e.g. LS29 9EZ"
                />
              </label>
            </div>

            <label class="space-y-1 block">
              <span class="text-sm font-semibold">Current website (if you have one)</span>
              <input
                name="website"
                type="text"
                inputmode="url"
                autocomplete="url"
                class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
                placeholder="yourdomain.co.uk"
              />
              <span class="text-xs text-ink/50">No need to include https:// or www</span>
            </label>

            <label class="space-y-1 block">
              <span class="text-sm font-semibold">What do you want help with? *</span>
              <textarea
                name="message"
                required
                minlength="5"
                rows="5"
                class="w-full rounded-md border border-ink/15 px-3 py-2 focus:border-accent focus:ring-2 focus:ring-accent/10 outline-none"
              ></textarea>
            </label>

            <div class="flex flex-wrap gap-3 pt-2 items-center">
              <Button
                type="submit"
                category="LOCAL_OFFER_APPLY"
                label="SUBMIT_APPLICATION"
                context="light"
                class="inline-flex items-center gap-2"
                disabled={!offerLive || slotsRemaining <= 0}
              >
                <MessageCircle class="w-5 h-5" aria-hidden="true" />
                Submit application
              </Button>

              <CtaLink
                href="/local-offer"
                category="LOCAL_OFFER_APPLY"
                label="BACK_TO_OFFER"
                class="inline-flex items-center gap-2 px-5 py-2 rounded-lg border-2 border-ink/15 text-ink font-semibold text-sm md:text-base hover:border-accent hover:text-accent transition"
              >
                <MapPin class="w-4 h-4" aria-hidden="true" />
                Back to offer
              </CtaLink>
            </div>

            {/* Messages BELOW the buttons */}
            {error && (
              <div class="mt-3 bg-accent/10 border border-accent/30 text-accent rounded-lg px-4 py-3 text-sm">
                {errorMessages[error] ?? 'Something isn’t right. Check the form and try again.'}
              </div>
            )}

            {sent && (
              <div class="mt-3 bg-ink/5 border border-ink/10 text-ink rounded-lg px-4 py-3 text-sm">
                Nice one. We’ve got it, and we’ll be in touch shortly.
              </div>
            )}

            <p class="text-[11px] text-ink/50 mt-2">
              By submitting, you confirm you’re eligible and agree to the Local Offer terms on our Terms &amp; Conditions page.
            </p>
          </form>
        </div>
      </div>
    </section>
  </main>

  <Footer />
  <CookieConsent />
</BaseLayout>
---
// src/pages/local-offer-apply.astro

import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieConsent from '../components/CookieConsent.astro';
import Button from '../components/Button.astro';
import CtaLink from '../components/CtaLink.astro';

import { MessageCircle, MapPin, BadgePercent } from '@lucide/astro';

import {
  offerLive,
  slotsRemaining,
  totalSlots,
  discountPercent,
  eligiblePlaces
} from '../data/local-offer.config';

const pageTitle = 'Apply for the Local Offer | Reignite Solutions';
const pageDesc =
  'Apply for the Ilkley local hello offer. One-time discount for businesses within 5 miles of Ilkley town centre.';

const url = new URL(Astro.request.url);
const error = url.searchParams.get('error');

const errorMessages = {
  name_missing: 'Please tell us your name.',
  email_missing: 'Please add your email address.',
  email_invalid: 'That email doesn’t look right.',
  message_missing: 'Tell us a bit about what you need.',
  location_missing: 'Tell us where your business is based.',
  postcode_invalid: 'That postcode doesn’t look like a valid UK postcode.',
  server_fail: 'Something went wrong. Try again or email us directly.',
};
---

<BaseLayout title={pageTitle} description={pageDesc}>
  <Header />

  <main class="bg-surface min-h-screen pb-12">
    {/* Hero / summary */}
    <section class="border-b border-ink/10 bg-gradient-to-b from-surface to-surface/60 pt-10 md:pt-16 pb-6 md:pb-8">
      <div class="container-reignite max-w-4xl space-y-4">
        <span
          class={`inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${
            offerLive ? 'bg-accent/10 text-accent' : 'bg-ink/10 text-ink'
          }`}
        >
          <BadgePercent class="w-3.5 h-3.5" aria-hidden="true" />
          Local hello offer
        </span>

        <h1 class="text-3xl md:text-4xl font-display font-extrabold leading-tight">
          Apply for the local offer
        </h1>

        <p class="text-lg text-ink/70 leading-relaxed">
          {offerLive && slotsRemaining > 0 ? (
            <>
              You’ll get <strong>{discountPercent}% off</strong> one project if you’re within 5 miles of Ilkley town centre.
              <br />
              <span class="text-xs text-ink/50">Slots remaining: {slotsRemaining} of {totalSlots}.</span>
              <span class="text-xs text-ink/50 ml-2">Terms and conditions apply.</span>
            </>
          ) : (
            <>
              This offer is currently closed. If you still want help, use the normal contact form.
            </>
          )}
        </p>

        <div class="text-sm text-ink/70 bg-surface border border-ink/10 rounded-xl p-4">
          Eligible places include: <strong>{eligiblePlaces.join(', ')}</strong>.
        </div>
      </div>
    </section>

    {/* Form */}
    <section class="py-10 md:py-14">
      <div class="container-reignite max-w-4xl">
        <div class="bg-white border border-ink/10 rounded-2xl shadow-sm p-6 md:p-9 space-y-6">
          <div class="space-y-2">
            <h2 class="text-xl md:text-2xl font-display font-bold">Quick application</h2>
            <p class="text-sm md:text-base text-ink/60">
              Fill this in and we’ll come back to you with next steps.
            </p>
          </div>

          <form
            method="POST"
            action="/api/contact"
            class="space-y-5"
          >
            <input type="hidden" name="formType" value="local-offer" />

            {/* Honeypot (hidden) */}
            <div class="hidden" aria-hidden="true">
              <label>
                Leave this field empty
                <input type="text" name="website_hp" tabindex="-1" autocomplete="off" />
              </label>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <label class="space-y-1">
                <span class="text-sm font-semibold text-ink">Your name *</span>
                <input
                  name="name"
                  required
                  minlength="2"
                  autocomplete="name"
                  class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-2.5 text-sm text-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
                />
              </label>

              <label class="space-y-1">
                <span class="text-sm font-semibold text-ink">Email *</span>
                <input
                  name="email"
                  type="email"
                  required
                  autocomplete="email"
                  class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-2.5 text-sm text-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
                />
              </label>
            </div>

            <label class="space-y-1 block">
              <span class="text-sm font-semibold text-ink">Business or organisation</span>
              <input
                name="company"
                autocomplete="organization"
                class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-2.5 text-sm text-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
                placeholder="Your business or trading name"
              />
            </label>

            <div class="grid gap-4 md:grid-cols-[2fr,1fr]">
              <label class="space-y-1">
                <span class="text-sm font-semibold text-ink">Town or village *</span>
                <input
                  name="town"
                  required
                  class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-2.5 text-sm text-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
                  placeholder="e.g. Ilkley, Ben Rhydding, Addingham…"
                />
              </label>

              <label class="space-y-1">
                <span class="text-sm font-semibold text-ink">Postcode</span>
                <input
                  name="postcode"
                  class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-2.5 text-sm text-ink shadow-sm uppercase tracking-wide focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
                  placeholder="LS29..."
                />
              </label>
            </div>

            <label class="space-y-1 block">
              <span class="text-sm font-semibold text-ink">Current website (if you have one)</span>
              <input
                name="website"
                class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-2.5 text-sm text-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
                placeholder="yourwebsite.co.uk"
              />
            </label>

            <label class="space-y-1 block">
              <span class="text-sm font-semibold text-ink">What do you want help with? *</span>
              <textarea
                name="message"
                required
                minlength="5"
                rows="5"
                class="w-full rounded-md border border-ink/15 bg-surface/60 px-4 py-3 text-sm text-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent"
              ></textarea>
            </label>

            <p class="text-[11px] text-ink/60">
              We usually reply the same working day. If you apply at a weekend or on a public holiday,
              we’ll come back to you on the next working day.
            </p>

            <div class="flex flex-wrap gap-3 pt-1 items-center">
              <Button
                type="submit"
                category="LOCAL_OFFER_APPLY"
                label="SUBMIT_APPLICATION"
                context="light"
                class="inline-flex items-center gap-2"
                disabled={!offerLive || slotsRemaining <= 0}
              >
                <MessageCircle class="w-5 h-5" aria-hidden="true" />
                Submit application
              </Button>

              <CtaLink
                href="/local-offer"
                category="LOCAL_OFFER_APPLY"
                label="BACK_TO_OFFER"
                class="btn btn-secondary inline-flex items-center gap-2"
              >
                <MapPin class="w-4 h-4" aria-hidden="true" />
                Back to offer details
              </CtaLink>
            </div>

            {error && (
              <div
                class="mt-3 bg-accent/10 border border-accent/30 text-accent rounded-lg px-4 py-3 text-sm"
                role="alert"
                aria-live="assertive"
              >
                {errorMessages[error] ?? 'Something isn’t right. Check the form and try again.'}
              </div>
            )}

            <div
              id="form-success"
              class="hidden rounded-md border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-900"
              role="status"
              aria-live="polite"
            >
              Nice one. We’ve got it, and we’ll be in touch shortly.
            </div>

            <p class="text-[11px] text-ink/50 mt-2 leading-relaxed">
              By submitting, you confirm you’re eligible and agree to the Local Offer terms on our Terms &amp; Conditions page.
            </p>
          </form>
        </div>
      </div>
    </section>
  </main>

  <Footer />
  <CookieConsent />

  <script is:inline>
    (function () {
      try {
        var params = new URLSearchParams(window.location.search);
        if (params.get('sent') === '1') {
          var el = document.getElementById('form-success');
          if (el) {
            el.classList.remove('hidden');

            if (typeof gtag === 'function') {
              gtag('event', 'generate_lead', {
                event_category: 'form',
                event_label: 'local_offer_application'
              });
            }

            var url = new URL(window.location.href);
            url.searchParams.delete('sent');
            url.searchParams.delete('error');
            window.history.replaceState({}, '', url.toString());

            el.setAttribute('tabindex', '-1');
            el.focus();
          }
        }
      } catch (_) {}
    })();
  </script>
</BaseLayout>